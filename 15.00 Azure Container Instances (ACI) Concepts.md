This comprehensive guide covers the fundamentals of Azure Container Services, focusing on **Azure Container Instances (ACI)**, its deployment models, configuration options, and troubleshooting commands.

-----

## Azure Container Instances (ACI) Concepts

**Azure Container Instances (ACI)** is a serverless solution that allows you to run Docker containers in Azure without managing underlying virtual machines or orchestration services. ACI is ideal for simple applications, task automation, and quick deployment of isolated containers.

### Container Groups

A **Container Group** is the top-level resource in ACI. It's a collection of containers that get scheduled on the same host machine, share a lifecycle, local network, and storage.

  * **Single-Container Group:** A basic deployment with only one container.
  * **Multi-Container Group:** A deployment that includes two or more containers.

### Multi-Container Groups

Multi-Container Groups are useful for scenarios where a primary application container needs a **sidecar** container for supplementary tasks, such as:

  * **Logging and Monitoring:** A separate container collects logs and metrics from the main application container.
  * **Data Transformation:** A primary application container processes data, and a sidecar container handles cleanup or transformation tasks.
  * **Shared Volume Access:** All containers in the group can share an attached volume (e.g., Azure File Share) for persistent or temporary data exchange.

> **Note:** Containers within a group can communicate with each other via `localhost` and a shared port. Multi-container groups are currently restricted to **Linux containers**.

-----

## How to Deploy Containers and Container Groups

Deployment is typically done using the **Azure CLI** or **YAML**/**Resource Manager Templates**.

### 1\. Single-Container Group Deployment (Azure CLI)

The simplest deployment uses the `az container create` command:

```bash
az container create \
  --resource-group myResourceGroup \
  --name myContainer \
  --image mcr.microsoft.com/azuredocs/aci-helloworld \
  --dns-name-label mydnsname \
  --ports 80
```

### 2\. Multi-Container Group Deployment (YAML)

For complex multi-container groups, defining the configuration in a **YAML file** and referencing it is the preferred method.

**`deploy-aci.yaml` example snippet:**

```yaml
apiVersion: 2019-12-01
location: eastus
name: myMultiContainerGroup
properties:
  containers:
  - name: aci-app
    properties:
      image: mcr.microsoft.com/azuredocs/aci-helloworld
      resources:
        requests:
          cpu: 1.0
          memoryInGb: 1.5
      ports:
      - port: 80
  - name: aci-sidecar
    properties:
      image: mcr.microsoft.com/azuredocs/aci-tutorial-sidecar
      resources:
        requests:
          cpu: 0.5
          memoryInGb: 1.0
  osType: Linux
  ipAddress:
    type: Public
    ports:
    - protocol: Tcp
      port: 80
```

**Deployment Command (Azure CLI with YAML):**

```bash
az container create \
  --resource-group myResourceGroup \
  --file deploy-aci.yaml
```

-----

## Container Configuration and Persistence

### Container Restart Policies

ACI automatically restarts containers based on the configured policy, which governs what happens after a container's main process finishes.

| Policy | Description |
| :--- | :--- |
| **Always** (Default) | The container is always restarted after it exits. Suitable for web servers and long-running services. |
| **Never** | The container is never restarted. Suitable for single-run tasks like script execution. |
| **OnFailure** | The container is only restarted if the primary process exits with a non-zero exit code (a failure). Suitable for batch jobs. |

**Example CLI deployment with `OnFailure`:**

```bash
az container create ... --restart-policy OnFailure
```

### Container Environment Variables

Environment variables are passed to the container to configure the application at runtime without modifying the container image.

  * **General Environment Variables:** Passed as key-value pairs.

    ```bash
    az container create ... \
      --environment-variables 'LOG_LEVEL'='DEBUG' 'APP_PORT'='8080'
    ```

  * **Secured Environment Variables:** Used for sensitive information like passwords or API keys. The values are not stored in clear text and cannot be retrieved after deployment.

    ```bash
    az container create ... \
      --secure-environment-variables 'DB_PASSWORD'='<my-secret-password>'
    ```

### Container Persistent Storage

For containers that need persistent state, you can mount **Azure File Shares** (Azure Files) to your container group.

**Example CLI for mounting an Azure File Share:**

```bash
# Get storage account key (replace <storage-key> and <storage-account-name>)
STORAGE_KEY=$(az storage account keys list \
  --resource-group myResourceGroup \
  --account-name <storage-account-name> \
  --query "[0].value" --output tsv)

# Deploy with volume mount
az container create \
  --resource-group myResourceGroup \
  --name myContainerWithVolume \
  --image mcr.microsoft.com/azuredocs/aci-tutorial-sidecar \
  --azure-file-volume-account-name <storage-account-name> \
  --azure-file-volume-account-key $STORAGE_KEY \
  --azure-file-volume-share-name myshare \
  --azure-file-volume-mount-path /mnt/azfiles
```

### Azure Container Registry (ACR)

**Azure Container Registry (ACR)** is a private, managed Docker registry service. It's used to store and manage your private container images and related artifacts (like Helm charts) in a secure, central location.

**Role with ACI:** ACI pulls images from ACR to deploy your private containerized applications. You must provide ACR credentials (username and password or a managed identity) during ACI deployment to grant access.

**Example CLI for using a private ACR image:**

```bash
az container create \
  --resource-group myResourceGroup \
  --name myPrivateContainer \
  --image <myACRName>.azurecr.io/myimage:v1 \
  --registry-login-server <myACRName>.azurecr.io \
  --registry-username <ACR-Username> \
  --registry-password <ACR-Password>
```

-----

## Container Troubleshooting Steps and Commands

Troubleshooting a container in ACI often involves checking the container's logs, attaching to its standard streams, and executing commands inside the running container.

### 1\. Check Container Logs

The most common first step is checking the output logs to diagnose startup failures or runtime errors.

| Command | Purpose |
| :--- | :--- |
| **`az container logs`** | Examines the output logs (STDOUT/STDERR) for a container in a group. |
| **Example:** | `az container logs --resource-group myResourceGroup --name myContainer --container-name aci-app` |
| **Follow Logs:** | Use the `--follow` flag to stream new log output in real-time. |

### 2\. Live Troubleshooting

These commands allow you to interact directly with a running container.

| Command | Purpose |
| :--- | :--- |
| **`az container attach`** | **Attaches** your local console to the container's standard output and error streams and its interactive shell (if supported). Useful for watching the container's output during startup. |
| **Example:** | `az container attach --resource-group myResourceGroup --name myContainer` |
| **`az container exec`** | **Executes** a command inside a running container. This is useful for running diagnostics, inspecting the file system, or checking network connectivity. |
| **Example:** | `az container exec --resource-group myResourceGroup --name myContainer --exec-command "/bin/bash"` (Opens an interactive shell) |
| **Example:** | `az container exec --resource-group myResourceGroup --name myContainer --exec-command "ls -l /app"` |

### 3\. Monitoring Metrics

To analyze resource usage and performance, you can check metrics exposed by ACI.

| Command | Purpose |
| :--- | :--- |
| **`az monitor metrics list`** | Retrieves the metric values (e.g., CPU usage, memory usage, network bytes) for an Azure resource, including Container Groups. |
| **Example:** | `az monitor metrics list --resource <Container Group Resource ID> --metric "CpuUsage" --interval PT5M` |
| **Get Resource ID:** | You first need the container group's resource ID: <br> `az container show --name myContainer --resource-group myResourceGroup --query id --output tsv` |
| **Metric Names:** | Common metrics for ACI include `CpuUsage`, `MemoryUsage`, `NetworkBytesIn`, and `NetworkBytesOut`. You can use `az monitor metrics list-definitions` to see all available metrics. |
